# HI_forecasts

This repository contains scripts to reproduce the 21cm intensity mapping forecasts in [https://arxiv.org/abs/2405.18559](https://arxiv.org/abs/2405.18559) (referred to as Foreman+ in the usage instructions below). These scripts require a special fork of FishLSS, available [here](https://github.com/sjforeman/FishLSS/tree/HI). They can be modified to generate forecasts for other 21cm surveys as well.

If you use these scripts in your work, please cite the following papers:
- Foreman, Obuljen, and Simonovic, "Improving cosmological analyses of HI clustering by reducing stochastic noise", [arXiv:2405.18559](https://arxiv.org/abs/2405.18559)
- Sailer et al., "Cosmology at high redshift - a probe of fundamental physics", JCAP12(2021)049, [arXiv:2106.09713](https://arxiv.org/abs/2106.09713)
- Chen, Vlah, Castorina, and White, "Redshift-space distortions in Lagrangian perturbation theory", JCAP03(2021)100, [arXiv:2012.04636](https://arxiv.org/abs/2012.04636)
- Chen, Vlah, and White, "Consistent Modeling of Velocity Statistics and Redshift-Space Distortions in One-Loop Perturbation Theory", JCAP07(2020)062, [arXiv:2005.00523](https://arxiv.org/abs/2005.00523)

## Included files
- `/input_files`: Power spectra, bias parameters, error power spectra, and sampling-noise power spectra measured from IllustrisTNG.
- `/notebooks`: Jupyter notebooks for making various plots.
- `/output`: Directory for output files from forecasts.
- `/plots`: Directory for plots generated by notebooks.
- `/runs`: Bash scripts that call `/scripts/generate.py` to generate power spectra, power spectrum derivatives, and other forecast metadata needed to compute Fisher matrices. These can be executed from the command line, and use `mpirun` to run several copies of `FishLSS` using MPI. The number of MPI ranks to use is set by `NTASKS` in the files, and you can modify this based on the number of cores available to you. The redshift binning, survey properties, and HI bias and stochasticity parameters are all set in these files.
- `/scripts`: Python scripts and modules used to generate the forecasts. `/scripts/generate.py` was described above, while `/scripts/compute_forecasts.py` is called by the other scripts in this directory to generate Fisher matrices. The `paper_forecasts_XXX` scripts can be run from the command line as described below, and are MPI-enabled to speed up computations.

## Usage
### To generate Figure 6 (power spectra at different redshifts) in Foreman+
1. From `/runs`, run the bash script `paper_powerspectra_for_plot_chordnoise.sh`, and use `/notebooks/paper_plots_powerspectra.ipynb` to make the plot. An alternative version of the plot that uses different thermal noise assumptions can also be made by first running `paper_powerspectra_for_plot_cvnoise.sh`.

### To generate the forecasts
1. From `/runs`, run the bash script `run_specderivs_chordnoise_knl0.4.sh`. (This will generate power spectrum derivatives needed for the Fisher forecasts, so it must be run first.) Then, run the other scripts in this directory, depending on which kNL and thermal noise assumptions you are interested in. This will generate several (<4) GB of files in `/output/specderivs/`.
2. From `/scripts`, run `mpirun -n N python paper_forecasts_nofullshapesigma8.py` where `N` is the number of MPI ranks you wish to use. Then, run `python paper_forecasts_cmbpluslensingonly.py` (which is not MPI-enabled). This will generate <500MB of files in `/output/forecasts`. Alternatively, the files used for the plots in Foreman+ are included in this repository as `forecasts.tar.gz`, so you can decompress this file if you want these exact files without re-running the scripts.
3. Use the `/notebooks/paper_plots_X.ipynb` notebooks to make the plots you desire.
